#!/bin/bash

# vim : set filetype=sh

for dir in ./*; do
	[ -e "$dir/item.json" ] || continue
	bin/article -A "$dir" -T ./template
done

itemsort="sort_by(.date_published) | reverse | del(.[]._ratan_blog_class)"
items=$(cat */item.json | jq -s "$itemsort")

latest_url=$(jq -n -r --argjson ITEMS "$items" '$ITEMS[0].url')
latest_dir=${latest_url##*/}
cp $latest_dir/index.html* .

jq -n -c -f template/jfroot.jq.json \
	--argjson ITEMS "$items" \
	| tee feeds/json \
	| gzip --best --force > feeds/json.gz

cat feeds/json | feedconv --atom \
	| tee feeds/atom \
	| gzip --best --force > feeds/atom.gz

cat feeds/json | feedconv --rss \
	| tee feeds/rss \
	| gzip --best --force > feeds/rss.gz
