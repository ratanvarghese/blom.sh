#!/bin/bash
# vim : set filetype=sh

for dir in ./*; do
	[ -e "$dir/item.json" ] || continue
	bin/article -A "$dir" -T ./template
done

itemsort="sort_by(.date_published) | reverse | del(.[]._ratan_blog_class)"
items=$(cat */item.json | jq -s "$itemsort")

host_url="http:\/\/www.ratan.blog"
tags_content=$(echo "$items" | sorttags | sed "s/($host_url/(/g" - |  markdown)
archive_content=$(echo "$items" | sortarchive | sed "s/($host_url/(/g" - | markdown)
today_tq=$(date | tqdate --short | tr -d "\n" | tr " " -)
today_gr=$(date --iso-8601 | tr -d "\n")

m4	-D_TITLE="Tags" \
	-D_TODAY_TQ="$today_tq" \
	-D_TODAY_GR="$today_gr" \
	-D_ARTICLE_CLASS="" \
	-D_TOTAL_CONTENT="$tags_content" \
	template/page.html \
	| tee tags/index.html \
	| gzip --best --force > tags/index.html.gz

m4	-D_TITLE="Archive" \
	-D_TODAY_TQ="$today_tq" \
	-D_TODAY_GR="$today_gr" \
	-D_ARTICLE_CLASS="" \
	-D_TOTAL_CONTENT="$archive_content" \
	template/page.html \
	| tee archive/index.html \
	| gzip --best --force > archive/index.html.gz

latest_url=$(jq -n -r --argjson ITEMS "$items" '$ITEMS[0].url')
latest_dir=${latest_url##*/}
cp $latest_dir/index.html* .

jq -n -c -f template/jfroot.jq.json \
	--argjson ITEMS "$items" \
	| tee feeds/json \
	| gzip --best --force > feeds/json.gz

cat feeds/json | feedconv --atom \
	| tee feeds/atom \
	| gzip --best --force > feeds/atom.gz

cat feeds/json | feedconv --rss \
	| tee feeds/rss \
	| gzip --best --force > feeds/rss.gz
